// # Thing.js
// flexible metaobjects with trait driven behavior
// MIT licensed, copyright Elijah Insua <tmpvar@gmail.com> 2011
(function(){function d(a,b){b=b||[],this._proto=a,this._traits={};var c=b.length||0;while(c--)this._traits[b[c]]=!0}function e(a){var c={};this.meta=function(a,b,d){return a&&b?(c[a]?c[a].frozen||(c[a].value=b):c[a]={value:b},d&&d.freeze&&(c[a].frozen=!0),c[a].value):c[a]?c[a].value||null:null};var d;a&&a.id?d=a.id:d=b++,this.meta("id",d,{freeze:!0})}var a={},b=0,c=a.toString=Object.prototype.toString;isArray=a.isArray=Array.isArray||function(a){return a.push&&"length"in a},d.prototype={has:function(a){return!!this._traits[a]},add:function(a){var b=e.traits;if(isArray(a)){var c=a.length,d=this._proto,f,g;while(c--){var g=a[c];if(b[g])this._traits[g]=!0,b[g](this._proto);else throw new Error('trait "'+a+'" does not exist')}}else if(b[a])this._traits[a]=!0,b[a](this._proto);else throw new Error('trait "'+a+'" does not exist')},remove:function(a){delete this._traits[a];var b={};e.traits[a](b);for(var c in b)b.hasOwnProperty(c)&&delete this._proto[c]}},a.TraitManager=d,e.prototype={},a.traits=e.traits={},a.createClass=function(a){a=a||[];var b=function(b){e.apply(this,arguments);var c=this.init._steps,d=c.length;b=typeof b=="undefined"?{}:b;while(d--)c[d].call(this,b)};return b.prototype=new e,b.prototype.init=function(a){this.init._steps.push(a)},b.prototype.init._steps=[],b.traits=new d(b.prototype,a),b.traits.add(a),b},a.trait=e.trait=function(a,b,c){arguments.length===2&&(c=b);var d=e.traits;if(!c)return d[a]||null;isArray(b)?b.push(a):b=[a],d[a]=function(f){var g=b.length,h;while(g--){var i=b[g];h=d[i];if(i===a)if(typeof c=="function")c(f);else for(var j in c)f[j]=c[j];else if(typeof h=="function")h(f);else{if(!h)throw new Error("Trait ("+i+") not found");for(var j in h)f[j]=h[j]}}}},a.create=function(b,c){var d=a.createClass(b);return new d(c)},a.wrap=function(b){if(b&&b.wrapped)return b;var c=new a.Value(b);return c.wrapped=!0,c},a.createReference=function(b,c,d){var e=a.wrap(d);return e.meta("owner",b),e.meta("name",c),e},a.trait("object",function(b){b.init(function(a){this._store=this._store||{};for(var b in a)this.set(b,a[b])}),b.set=function(c,d,e){this._store||(this._store={});if(!d&&isNaN(d))throw new Error("attempted to set "+c+" to NaN!;"+d);this._store[c]&&typeof this._store[c].set=="function"?d&&d.set&&d.current?this._store[c].set(d.current,e):this._store[c].set(d,e):this._store[c]=a.createReference(this,c,d)},b.get=function(b){if(this._store[b]){var c=this._store[b];return c.get&&typeof c.get=="function"?c.get():c}return null},b.toJSON=function(){var a={};for(var b in this._store)if(this._store.hasOwnProperty(b)){var c=this._store[b];c&&c.toJSON()?a[b]=c.toJSON():a[b]=c}return a},b.reference=b.ref=function(b){return a.createReference(this,b,this._store[b])}}),a.Object=a.createClass(["object"]),a.trait("object.value",function(a){a.init(function(a){this._observers=[],this.current=a,a&&a.update&&(this.update=a.update,this.update())}),a.on=function(a){this._observers.push(a)},a.notify=function(a){if(!this._observers){var b=this;setTimeout(function(){b.notify(a)},16)}else for(var c=0,d=this._observers.length;c<d;c++)this._observers[c](a,this)},a.set=function(a,b){this.current=a,(!b||!b.silent)&&this.notify(a)},a.resolve=function(a,b,c){var d=a.get(b),e=this;return d.on(function(){e.update()}),c?d:d.current},a.get=function(){return this.current},a.toJSON=function(){return this.current&&this.current.toJSON?this.current.toJSON():this.current}}),a.Value=a.createClass(["object.value"]),a.trait("object.collection",["object.value"],function(a){a.init(function(a){this.meta("contains",{})}),a.add=function(b){this.current.push(b),b&&b.meta&&(this.meta("contains")[b.meta("id")]=!0),this.notify(b)},a.wrapped=!0,a.length=function(){return this.current.length||0},a.remove=function(a){var b=this.current.length;while(b--)this.current[b]===a&&this.current.splice(b,1);delete this.meta("contains")[a.meta("id")],this.notify(a)},a.filter=function(a){var b=this.current.length;while(b--)a(this.current[b])||this.current.splice(b,1)},a.each=function(a){var b=0,c=this.current.length;for(b;b<c;b++)if(a(this.current[b])===!1)break},a.intersect=function(a){console.log("contains",this.meta("contains"))}}),a.Collection=a.createClass(["object.collection"]),a.constant=function(b){var c=a.wrap(b);return c.set=function(){},c},typeof module!="undefined"?module.exports=a:window.Thing=a})();